import{w as y,n as B,q as j,x as S,y as k,C as L,i as x,z as M}from"./iframe.23e5df09.js";import{M as Y}from"./index.0b223fd3.js";var K=(e=>(e.DONE="done",e.ERROR="error",e.ACTIVE="active",e.WAITING="waiting",e))(K||{}),p={CALL:"storybook/instrumenter/call",SYNC:"storybook/instrumenter/sync",START:"storybook/instrumenter/start",BACK:"storybook/instrumenter/back",GOTO:"storybook/instrumenter/goto",NEXT:"storybook/instrumenter/next",END:"storybook/instrumenter/end"},C,D=((C=y.FEATURES)==null?void 0:C.interactionsDebugger)!==!0,T={debugger:!D,start:!1,back:!1,goto:!1,next:!1,end:!1},E=new Error("This function ran after the play function completed. Did you forget to `await` it?"),R=e=>Object.prototype.toString.call(e)==="[object Object]",z=e=>Object.prototype.toString.call(e)==="[object Module]",F=e=>{if(!R(e)&&!z(e))return!1;if(e.constructor===void 0)return!0;let t=e.constructor.prototype;return!(!R(t)||Object.prototype.hasOwnProperty.call(t,"isPrototypeOf")===!1)},G=e=>{try{return new e.constructor}catch{return{}}},m=()=>({renderPhase:void 0,isDebugging:!1,isPlaying:!1,isLocked:!1,cursor:0,calls:[],shadowCalls:[],callRefsByResult:new Map,chainedCallIds:new Set,ancestors:[],playUntil:void 0,resolvers:{},syncTimeout:void 0}),N=(e,t=!1)=>{let l=(t?e.shadowCalls:e.calls).filter(i=>i.retain);if(!l.length)return;let o=new Map(Array.from(e.callRefsByResult.entries()).filter(([,i])=>i.retain));return{cursor:l.length,calls:l,callRefsByResult:o}},V=class{constructor(){this.initialized=!1,this.channel=j.getChannel(),this.state=y.window.parent.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER_STATE__||{};let e=({storyId:a,isPlaying:r=!0,isDebugging:s=!1})=>{let n=this.getState(a);this.setState(a,{...m(),...N(n,s),shadowCalls:s?n.shadowCalls:[],chainedCallIds:s?n.chainedCallIds:new Set,playUntil:s?n.playUntil:void 0,isPlaying:r,isDebugging:s}),this.sync(a)};this.channel.on(S,e),this.channel.on(k,({storyId:a,newPhase:r})=>{let{isDebugging:s}=this.getState(a);this.setState(a,{renderPhase:r}),r==="preparing"&&s&&e({storyId:a}),r==="playing"&&e({storyId:a,isDebugging:s}),r==="played"&&this.setState(a,{isLocked:!1,isPlaying:!1,isDebugging:!1}),r==="errored"&&this.setState(a,{isLocked:!1,isPlaying:!1})}),this.channel.on(L,()=>{this.initialized?this.cleanup():this.initialized=!0});let t=({storyId:a,playUntil:r})=>{this.getState(a).isDebugging||this.setState(a,({calls:n})=>({calls:[],shadowCalls:n.map(c=>({...c,status:"waiting"})),isDebugging:!0}));let s=this.getLog(a);this.setState(a,({shadowCalls:n})=>{var u;if(r||!s.length)return{playUntil:r};let c=n.findIndex(h=>h.id===s[0].callId);return{playUntil:(u=n.slice(0,c).filter(h=>h.interceptable&&!h.ancestors.length).slice(-1)[0])==null?void 0:u.id}}),this.channel.emit(S,{storyId:a,isDebugging:!0})},l=({storyId:a})=>{var n;let r=this.getLog(a).filter(c=>!c.ancestors.length),s=r.reduceRight((c,u,h)=>c>=0||u.status==="waiting"?c:h,-1);t({storyId:a,playUntil:(n=r[s-1])==null?void 0:n.callId})},o=({storyId:a,callId:r})=>{var _;let{calls:s,shadowCalls:n,resolvers:c}=this.getState(a),u=s.find(({id:g})=>g===r),h=n.find(({id:g})=>g===r);if(!u&&h&&Object.values(c).length>0){let g=(_=this.getLog(a).find(f=>f.status==="waiting"))==null?void 0:_.callId;h.id!==g&&this.setState(a,{playUntil:h.id}),Object.values(c).forEach(f=>f())}else t({storyId:a,playUntil:r})},i=({storyId:a})=>{var s;let{resolvers:r}=this.getState(a);if(Object.values(r).length>0)Object.values(r).forEach(n=>n());else{let n=(s=this.getLog(a).find(c=>c.status==="waiting"))==null?void 0:s.callId;n?t({storyId:a,playUntil:n}):d({storyId:a})}},d=({storyId:a})=>{this.setState(a,{playUntil:void 0,isDebugging:!1}),Object.values(this.getState(a).resolvers).forEach(r=>r())};this.channel.on(p.START,t),this.channel.on(p.BACK,l),this.channel.on(p.GOTO,o),this.channel.on(p.NEXT,i),this.channel.on(p.END,d)}getState(e){return this.state[e]||m()}setState(e,t){let l=this.getState(e),o=typeof t=="function"?t(l):t;this.state={...this.state,[e]:{...l,...o}},y.window.parent.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER_STATE__=this.state}cleanup(){this.state=Object.entries(this.state).reduce((t,[l,o])=>{let i=N(o);return i&&(t[l]=Object.assign(m(),i)),t},{});let e={controlStates:T,logItems:[]};this.channel.emit(p.SYNC,e),y.window.parent.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER_STATE__=this.state}getLog(e){let{calls:t,shadowCalls:l}=this.getState(e),o=[...l];t.forEach((d,a)=>{o[a]=d});let i=new Set;return o.reduceRight((d,a)=>(a.args.forEach(r=>{r!=null&&r.__callId__&&i.add(r.__callId__)}),a.path.forEach(r=>{r.__callId__&&i.add(r.__callId__)}),(a.interceptable||a.exception)&&!i.has(a.id)&&(d.unshift({callId:a.id,status:a.status,ancestors:a.ancestors}),i.add(a.id)),d),[])}instrument(e,t){if(!F(e))return e;let{mutate:l=!1,path:o=[]}=t;return Object.keys(e).reduce((i,d)=>{let a=e[d];return typeof a!="function"?(i[d]=this.instrument(a,{...t,path:o.concat(d)}),i):typeof a.__originalFn__=="function"?(i[d]=a,i):(i[d]=(...r)=>this.track(d,a,r,t),i[d].__originalFn__=a,Object.defineProperty(i[d],"name",{value:d,writable:!1}),Object.keys(a).length>0&&Object.assign(i[d],this.instrument({...a},{...t,path:o.concat(d)})),i)},l?e:G(e))}track(e,t,l,o){var g,f,I,b;let i=((g=l==null?void 0:l[0])==null?void 0:g.__storyId__)||((b=(I=(f=y.window.__STORYBOOK_PREVIEW__)==null?void 0:f.urlStore)==null?void 0:I.selection)==null?void 0:b.storyId),{cursor:d,ancestors:a}=this.getState(i);this.setState(i,{cursor:d+1});let r=`${a.slice(-1)[0]||i} [${d}] ${e}`,{path:s=[],intercept:n=!1,retain:c=!1}=o,u=typeof n=="function"?n(e,s):n,h={id:r,cursor:d,storyId:i,ancestors:a,path:s,method:e,args:l,interceptable:u,retain:c},_=(u&&!a.length?this.intercept:this.invoke).call(this,t,h,o);return this.instrument(_,{...o,mutate:!0,path:[{__callId__:h.id}]})}intercept(e,t,l){let{chainedCallIds:o,isDebugging:i,playUntil:d}=this.getState(t.storyId),a=o.has(t.id);return!i||a||d?(d===t.id&&this.setState(t.storyId,{playUntil:void 0}),this.invoke(e,t,l)):new Promise(r=>{this.setState(t.storyId,({resolvers:s})=>({isLocked:!1,resolvers:{...s,[t.id]:r}}))}).then(()=>(this.setState(t.storyId,r=>{let{[t.id]:s,...n}=r.resolvers;return{isLocked:!0,resolvers:n}}),this.invoke(e,t,l)))}invoke(e,t,l){let{callRefsByResult:o,renderPhase:i}=this.getState(t.storyId),d=s=>{var n,c;if(o.has(s))return o.get(s);if(s instanceof Array)return s.map(d);if(s instanceof Date)return{__date__:{value:s.toISOString()}};if(s instanceof Error){let{name:u,message:h,stack:_}=s;return{__error__:{name:u,message:h,stack:_}}}if(s instanceof RegExp){let{flags:u,source:h}=s;return{__regexp__:{flags:u,source:h}}}if(s instanceof y.window.HTMLElement){let{prefix:u,localName:h,id:_,classList:g,innerText:f}=s,I=Array.from(g);return{__element__:{prefix:u,localName:h,id:_,classNames:I,innerText:f}}}return typeof s=="function"?{__function__:{name:s.name}}:typeof s=="symbol"?{__symbol__:{description:s.description}}:typeof s=="object"&&((n=s==null?void 0:s.constructor)==null?void 0:n.name)&&((c=s==null?void 0:s.constructor)==null?void 0:c.name)!=="Object"?{__class__:{name:s.constructor.name}}:Object.prototype.toString.call(s)==="[object Object]"?Object.fromEntries(Object.entries(s).map(([u,h])=>[u,d(h)])):s},a={...t,args:t.args.map(d)};t.path.forEach(s=>{s!=null&&s.__callId__&&this.setState(t.storyId,({chainedCallIds:n})=>({chainedCallIds:new Set(Array.from(n).concat(s.__callId__))}))});let r=s=>{if(s instanceof Error){let{name:n,message:c,stack:u,callId:h=t.id}=s,_={name:n,message:c,stack:u,callId:h};if(this.update({...a,status:"error",exception:_}),this.setState(t.storyId,g=>({callRefsByResult:new Map([...Array.from(g.callRefsByResult.entries()),[s,{__callId__:t.id,retain:t.retain}]])})),t.ancestors.length)throw Object.prototype.hasOwnProperty.call(s,"callId")||Object.defineProperty(s,"callId",{value:t.id}),s;if(s!==E)throw x.warn(s),M}throw s};try{if(i==="played"&&!t.retain)throw E;let s=(l.getArgs?l.getArgs(t,this.getState(t.storyId)):t.args).map(c=>typeof c!="function"||Object.keys(c).length?c:(...u)=>{let{cursor:h,ancestors:_}=this.getState(t.storyId);this.setState(t.storyId,{cursor:0,ancestors:[..._,t.id]});let g=()=>this.setState(t.storyId,{cursor:h,ancestors:_}),f=!1;try{let I=c(...u);return I instanceof Promise?(f=!0,I.finally(g)):I}finally{f||g()}}),n=e(...s);return n&&["object","function","symbol"].includes(typeof n)&&this.setState(t.storyId,c=>({callRefsByResult:new Map([...Array.from(c.callRefsByResult.entries()),[n,{__callId__:t.id,retain:t.retain}]])})),this.update({...a,status:n instanceof Promise?"active":"done"}),n instanceof Promise?n.then(c=>(this.update({...a,status:"done"}),c),r):n}catch(s){return r(s)}}update(e){this.channel.emit(p.CALL,e),this.setState(e.storyId,({calls:t})=>{let l=t.concat(e).reduce((o,i)=>Object.assign(o,{[i.id]:i}),{});return{calls:Object.values(l).sort((o,i)=>o.id.localeCompare(i.id,void 0,{numeric:!0}))}}),this.sync(e.storyId)}sync(e){let t=()=>{var n;let{isLocked:l,isPlaying:o}=this.getState(e),i=this.getLog(e),d=(n=i.filter(({ancestors:c})=>!c.length).find(c=>c.status==="waiting"))==null?void 0:n.callId,a=i.some(c=>c.status==="active");if(D||l||a||i.length===0){let c={controlStates:T,logItems:i};this.channel.emit(p.SYNC,c);return}let r=i.some(c=>["done","error"].includes(c.status)),s={controlStates:{debugger:!0,start:r,back:r,goto:!0,next:o,end:o},logItems:i,pausedAt:d};this.channel.emit(p.SYNC,s)};this.setState(e,({syncTimeout:l})=>(clearTimeout(l),{syncTimeout:setTimeout(t,0)}))}};function P(e,t={}){var l,o,i,d;try{let a=!1,r=!1;return(o=(l=y.window.location)==null?void 0:l.search)!=null&&o.includes("instrument=true")?a=!0:(d=(i=y.window.location)==null?void 0:i.search)!=null&&d.includes("instrument=false")&&(r=!0),y.window.parent===y.window&&!a||r?e:(y.window.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER__||(y.window.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER__=new V),y.window.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER__.instrument(e,t))}catch(a){return B.warn(a),e}}var v=new Y(window),W=v.fn.bind(v),{action:X}=P({action:W},{retain:!0}),U=j.getChannel(),A=new Set,w=[];U.on(S,()=>w.forEach(e=>{var t;return(t=e==null?void 0:e.mockClear)==null?void 0:t.call(e)}));U.on(k,({newPhase:e})=>{e==="loading"&&w.forEach(t=>{var l;return(l=t==null?void 0:t.mockClear)==null?void 0:l.call(t)})});var O=(e,t,l)=>{if(A.has(t))return t;A.add(t);try{if(Object.prototype.toString.call(t)==="[object Object]"){for(let[o,i]of Object.entries(t))t[o]=O(e,i,o);return t}if(Array.isArray(t))return t.map((o,i)=>O(e,o,`${l}[${i}]`));if(typeof t=="function"&&t.isAction){Object.defineProperty(t,"name",{value:l,writable:!1}),Object.defineProperty(t,"__storyId__",{value:e,writable:!1});let o=X(t);return w.push(o),o}}catch{}return t},$=({id:e,initialArgs:t})=>O(e,t),J=[$],{step:Q}=P({step:(e,t,l)=>t(l)},{intercept:!0}),Z={throwPlayFunctionExceptions:!1};export{J as argsEnhancers,Z as parameters,Q as runStep};
//# sourceMappingURL=preview.2ee97a44.js.map
